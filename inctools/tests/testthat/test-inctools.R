test_that("mdri estimation works", {
  expect_equal(mdrical(data=excalibdata,
                       subid_var = "SubjectID",
                       time_var = "DaysSinceEDDI",
                       recency_cutoff_time = 730.5,
                       inclusion_time_threshold = 800,
                       functional_forms = c("logit_cubic"),
                       recency_rule = "binary_data",
                       recency_vars = "Recent",
                       n_bootstraps = 0,
                       plot = FALSE,
                       parallel = FALSE)$MDRI$PE, 
               235.8039,
               tolerance = 1e-05)
  expect_equal(mdrical(data=excalibdata,
                       subid_var = "SubjectID",
                       time_var = "DaysSinceEDDI",
                       recency_cutoff_time = 730.5,
                       inclusion_time_threshold = 800,
                       functional_forms = c("cloglog_linear"),
                       recency_rule = "binary_data",
                       recency_vars = "Recent",
                       n_bootstraps = 0,
                       plot = FALSE,
                       parallel = FALSE)$MDRI$PE, 
               248.1445,
               tolerance = 1e-05)
  expect_equal(mdrical(data=excalibdata,
                       subid_var = "SubjectID",
                       time_var = "DaysSinceEDDI",
                       recency_cutoff_time = 730.5,
                       inclusion_time_threshold = 800,
                       functional_forms = c("cloglog_linear"),
                       recency_rule = "binary_data",
                       recency_vars = "Recent",
                       n_bootstraps = 100,
                       random_seed = 123,
                       plot = FALSE,
                       parallel = FALSE)$MDRI$SE,
               12.5850,
               tolerance = 1e-05)
  expect_equal(mdrical(data=excalibdata,
                       subid_var = "SubjectID",
                       time_var = "DaysSinceEDDI",
                       recency_cutoff_time = 730.5,
                       inclusion_time_threshold = 800,
                       functional_forms = c("cloglog_linear"),
                       recency_rule = "binary_data",
                       recency_vars = "Recent",
                       n_bootstraps = 1000,
                       random_seed = 123,
                       plot = FALSE,
                       parallel = TRUE,
                       cores = 4)$MDRI$SE,
               13.70371,
               tolerance = 1e-05)
})

test_that("mdrical() error messages work", {
  expect_error(
    mdrical(subid_var = "SubjectID",
            time_var = "DaysSinceEDDI",
            recency_cutoff_time = 730.5,
            inclusion_time_threshold = 800,
            functional_forms = c("cloglog_linear"),
            recency_rule = "binary_data",
            recency_vars = "Recent",
            n_bootstraps = 0,
            plot = FALSE,
            parallel = FALSE),
    "No input data has been specified", fixed = TRUE
  )
  expect_error(
    mdrical(data=excalibdata,
            time_var = "DaysSinceEDDI",
            recency_cutoff_time = 730.5,
            inclusion_time_threshold = 800,
            functional_forms = c("cloglog_linear"),
            recency_rule = "binary_data",
            recency_vars = "Recent",
            n_bootstraps = 0,
            plot = FALSE,
            parallel = FALSE),
    "No subject identifier has been specified", fixed = TRUE
  )
  expect_error(
    mdrical(data=excalibdata,
            subid_var = "SubjectID",
            time_var = "DaysSinceEDDI",
            recency_cutoff_time = 730.5,
            inclusion_time_threshold = 800,
            functional_forms = c("logit_cubic"),
            recency_rule = "garbage_rule",
            recency_vars = "Recent",
            n_bootstraps = 0,
            plot = FALSE,
            parallel = FALSE),
    "Please specify a valid recency rule", fixed = TRUE
  )
  expect_error(
    mdrical(data=excalibdata,
            subid_var = "SubjectID",
            time_var = "DaysSinceEDDI",
            recency_cutoff_time = 730.5,
            inclusion_time_threshold = 800,
            functional_forms = c("logit_cubic"),
            recency_rule = "binary_data",
            recency_vars = c("Result","VL"),
            recency_params = c(10,0,1000,1),
            n_bootstraps = 0,
            plot = FALSE,
            parallel = FALSE),
    "Binary data should have one recency variable", fixed = TRUE
  )
  expect_error(
    mdrical(data=excalibdata,
            subid_var = "SubjectID",
            time_var = "DaysSinceEDDI",
            recency_cutoff_time = 730.5,
            inclusion_time_threshold = 800,
            functional_forms = c("logit_cubic"),
            recency_rule = "independent_thresholds",
            recency_vars = "Recent",
            recency_params =c(10,0,1000,1),
            n_bootstraps = 0,
            plot = FALSE,
            parallel = FALSE),
    "The number of recency variables must match the number of recency paramaters", fixed = TRUE
  )
  expect_error(
    mdrical(data=excalibdata,
            subid_var = "SubjectID",
            time_var = "DaysSinceEDDI",
            recency_cutoff_time = 730.5,
            inclusion_time_threshold = 800,
            functional_forms = c("logit"),
            recency_rule = "binary_data",
            recency_vars = "Recent",
            n_bootstraps = 0,
            plot = FALSE,
            parallel = FALSE),
    "Please specify valid functional form(s)", fixed = TRUE
  )
})

test_that("frr estimation works", {
  expect_equal(frrcal(data=excalibdata,
                      subid_var = "SubjectID",
                      time_var = "DaysSinceEDDI",
                      recency_cutoff_time = 730.5,
                      recency_rule = "independent_thresholds",
                      recency_vars = c("Result","VL"),
                      recency_params = c(10,0,1000,1),
                      alpha = 0.05)$FRRest, 0.03007519)
  expect_equal(frrcal(data=excalibdata,
                      subid_var = "SubjectID",
                      time_var = "DaysSinceEDDI",
                      recency_cutoff_time = 730.5,
                      recency_rule = "independent_thresholds",
                      recency_vars = c("Result","VL"),
                      recency_params = c(10,0,1000,1),
                      alpha = 0.05,
                      method = "probit")$ci_method, "probit")
  expect_equal(frrcal(data=excalibdata,
                      subid_var = "SubjectID",
                      time_var = "DaysSinceEDDI",
                      recency_cutoff_time = 730.5,
                      recency_rule = "independent_thresholds",
                      recency_vars = c("Result","VL"),
                      recency_params = c(10,0,1000,1),
                      alpha = 0.05,
                      method = "probit")$CI_LB, 0.01460227)
  expect_equal(frrcal(data=excalibdata,
                      subid_var = "SubjectID",
                      time_var = "DaysSinceEDDI",
                      recency_cutoff_time = 730.5,
                      recency_rule = "independent_thresholds",
                      recency_vars = c("Result","VL"),
                      recency_params = c(10,0,1000,1),
                      alpha = 0.05,
                      method = "probit")$CI_UB, 0.05720647)
})

test_that("incidence estimation works", {
  expect_equal(incprops(PrevH = 0.20, 
                        RSE_PrevH = 0.028, 
                        PrevR = 0.10, 
                        RSE_PrevR = 0.09,
                        Boot = FALSE, 
                        MDRI = 200, 
                        RSE_MDRI = 0.05,
                        FRR = 0.01, 
                        RSE_FRR = 0.2, 
                        BigT = 730.5, 
                        debug = FALSE)$Incidence.Statistics$Incidence, 
               0.04264836)
  expect_equal(incprops(PrevH = c(0.20,0.21,0.18), 
                        RSE_PrevH = c(0.028,0.03,0.022),
                        PrevR = c(0.10,0.13,0.12), 
                        RSE_PrevR = c(0.094,0.095,0.05),
                        Boot = FALSE, 
                        BMest = 'MDRI.FRR.indep',
                        MDRI = c(200,180,180), 
                        RSE_MDRI = c(0.05,0.07,0.06),
                        FRR = c(0.01,0.009,0.02), 
                        RSE_FRR = c(0.2,0.2,0.1), 
                        BigT = 730.5)$Incidence.Difference.Statistics$p_value,
               c(0.01491562,0.39928244,0.01491562,0.05327965,0.39928244,0.05327965))
})

test_that("inccounts() and incprops() give the same answers", {
  expect_equal(inccounts(N = 10000,
                         N_H = 1000,
                         N_testR = 990,
                         N_R = 99,
                         DE_H = 1.2,
                         DE_R = 1.2,
                         Boot = FALSE,
                         alpha = 0.05,
                         MDRI= 200,
                         RSE_MDRI = 0.1,
                         FRR = 0.01,
                         RSE_FRR = 0.25,
                         BigT = 730.5,
                         Covar_HR = 0,
                         debug = FALSE)$Incidence.Statistics$Incidence,
               incprops(PrevH = 0.1, 
                        RSE_PrevH = 0.03286335,
                        PrevR = 0.1, 
                        RSE_PrevR = 0.1044466,
                        Boot = FALSE,
                        alpha = 0.05,
                        MDRI= 200,
                        RSE_MDRI = 0.1,
                        FRR = 0.01,
                        RSE_FRR = 0.25,
                        BigT = 730.5,
                        Covar_HR = 0,
                        debug = FALSE)$Incidence.Statistics$Incidence)
  expect_equal(inccounts(N = 10000,
                         N_H = 1000,
                         N_testR = 990,
                         N_R = 99,
                         DE_H = 1.2,
                         DE_R = 1.2,
                         Boot = FALSE,
                         alpha = 0.05,
                         MDRI= 200,
                         RSE_MDRI = 0.1,
                         FRR = 0.01,
                         RSE_FRR = 0.25,
                         BigT = 730.5,
                         Covar_HR = 0,
                         debug = FALSE)$Annual.Risk.of.Infection$ARI,
               incprops(PrevH = 0.1, 
                        RSE_PrevH = 0.03286335,
                        PrevR = 0.1, 
                        RSE_PrevR = 0.1044466,
                        Boot = FALSE,
                        alpha = 0.05,
                        MDRI= 200,
                        RSE_MDRI = 0.1,
                        FRR = 0.01,
                        RSE_FRR = 0.25,
                        BigT = 730.5,
                        Covar_HR = 0,
                        debug = FALSE)$Annual.Risk.of.Infection$ARI)  
})

test_that("power calculation works", {
  expect_equal(incpower(I1 = 0.05, 
                        I2 = 0.03, 
                        PrevH1 = 0.20, 
                        PrevH2 = 0.20,
                        n1 = 5000, 
                        n2 = 5000, 
                        alpha = 0.05, 
                        Power = "out", 
                        SS = NULL,
                        DE_H = c(1,1.1), 
                        DE_R = 1, 
                        BMest = "same.test", 
                        MDRI = 200,
                        RSE_MDRI = 0.05, 
                        FRR = 0.01, 
                        RSE_FRR = 0.20, 
                        BigT = 730.5)$Inc.Difference.Statistics$Power,
               0.8569811,
               tolerance = 1e-07)
  expect_equal(incpower(I1 = 0.05, 
                        I2 = 0.03, 
                        PrevH1 = 0.20, 
                        PrevH2 = 0.20,
                        n1 = 5000, 
                        n2 = 5000, 
                        alpha = 0.05, 
                        Power = "out", 
                        SS = NULL,
                        DE_H = c(1,1.1), 
                        DE_R = 1, 
                        BMest = "same.test", 
                        MDRI = 200,
                        RSE_MDRI = 0.05, 
                        FRR = 0.01, 
                        RSE_FRR = 0.20, 
                        BigT = 730.5)$Inc.Difference.Statistics$RSE_deltaI,
               0.3303799,
               tolerance = 1e-07)
  expect_equal(incpower(I1 = 0.05, 
                        I2 = 0.03, 
                        PrevH1 = 0.20, 
                        PrevH2 = 0.20,
                        n1 = 5000, 
                        n2 = 5000, 
                        alpha = 0.05, 
                        Power = "out", 
                        SS = NULL,
                        DE_H = c(1,1.1), 
                        DE_R = 1, 
                        BMest = "same.test", 
                        MDRI = 200,
                        RSE_MDRI = 0.05, 
                        FRR = 0.01, 
                        RSE_FRR = 0.20, 
                        BigT = 730.5)$Inc.Difference.Statistics$RSE_deltaI.infSS,
               0.05244642,
               tolerance = 1e-07)
  expect_equal(incpower(I1 = 0.05, 
                        I2 = 0.03, 
                        PrevH1 = 0.20, 
                        PrevH2 = 0.20,
                        alpha = 0.05, 
                        Power = 0.8, 
                        SS = "out",
                        DE_H = c(1,1.1), 
                        DE_R = 1, 
                        BMest = "same.test", 
                        MDRI = 200,
                        RSE_MDRI = 0.05, 
                        FRR = 0.01, 
                        RSE_FRR = 0.20, 
                        BigT = 730.5)$Minimum.Common.SS,
               4268)
  expect_equal(incpower(I1 = 0.05, 
                        I2 = 0.03, 
                        PrevH1 = 0.20, 
                        PrevH2 = 0.20,
                        n1 = 5000, 
                        n2 = 5000, 
                        alpha = 0.05, 
                        Power = "out", 
                        SS = NULL,
                        DE_H = c(1,1.1), 
                        DE_R = 1, 
                        BMest = "FRR.indep",
                        MDRI = 200,
                        RSE_MDRI = 0.05, 
                        FRR = c(0.01, 0.02), 
                        RSE_FRR = c(0.20, 0.15),  
                        BigT = 730.5)$Inc.Difference.Statistics$Power,
               0.8238909,
               tolerance = 1e-07)
  expect_equal(incpower(I1 = 0.05, 
                        I2 = 0.03, 
                        PrevH1 = 0.20, 
                        PrevH2 = 0.20,
                        n1 = 5000, 
                        n2 = 5000, 
                        alpha = 0.05, 
                        Power = "out", 
                        SS = NULL,
                        DE_H = c(1,1.1), 
                        DE_R = 1, 
                        BMest = "FRR.indep", 
                        MDRI = 200,
                        RSE_MDRI = 0.05, 
                        FRR = c(0.01, 0.02), 
                        RSE_FRR = c(0.20, 0.15), 
                        BigT = 730.5)$Inc.Difference.Statistics$RSE_deltaI,
               0.3459897,
               tolerance = 1e-07)
  expect_equal(incpower(I1 = 0.05, 
                        I2 = 0.03, 
                        PrevH1 = 0.20, 
                        PrevH2 = 0.20,
                        n1 = 5000, 
                        n2 = 5000, 
                        alpha = 0.05, 
                        Power = "out", 
                        SS = NULL,
                        DE_H = c(1,1.1), 
                        DE_R = 1, 
                        BMest = "FRR.indep", 
                        MDRI = 200,
                        RSE_MDRI = 0.05, 
                        FRR = c(0.01, 0.02), 
                        RSE_FRR = c(0.20, 0.15), 
                        BigT = 730.5)$Inc.Difference.Statistics$RSE_deltaI.infSS,
               0.07965797,
               tolerance = 1e-07)
  expect_equal(incpower(I1 = 0.05, 
                        I2 = 0.03, 
                        PrevH1 = 0.20, 
                        PrevH2 = 0.20,
                        alpha = 0.05, 
                        Power = 0.8, 
                        SS = "out",
                        DE_H = c(1,1.1), 
                        DE_R = 1, 
                        BMest = "FRR.indep", 
                        MDRI = 200,
                        RSE_MDRI = 0.05, 
                        FRR = c(0.01, 0.02), 
                        RSE_FRR = c(0.20, 0.15),  
                        BigT = 730.5)$Minimum.Common.SS,
               4683)
  expect_equal(incpower(I1 = 0.05, 
                        I2 = 0.03, 
                        PrevH1 = 0.20, 
                        PrevH2 = 0.20,
                        n1 = 5000, 
                        n2 = 5000, 
                        alpha = 0.05, 
                        Power = "out", 
                        SS = NULL,
                        DE_H = c(1,1.1), 
                        DE_R = 1, 
                        BMest = "MDRI.FRR.indep",
                        MDRI = c(200, 180),
                        RSE_MDRI = c(0.05, 0.1), 
                        FRR = c(0.01, 0.02), 
                        RSE_FRR = c(0.20, 0.15),  
                        BigT = 730.5)$Inc.Difference.Statistics$Power,
               0.6818551,
               tolerance = 1e-07)
  expect_equal(incpower(I1 = 0.05, 
                        I2 = 0.03, 
                        PrevH1 = 0.20, 
                        PrevH2 = 0.20,
                        n1 = 5000, 
                        n2 = 5000, 
                        alpha = 0.05, 
                        Power = "out", 
                        SS = NULL,
                        DE_H = c(1,1.1), 
                        DE_R = 1, 
                        BMest = "MDRI.FRR.indep", 
                        MDRI = c(200, 180),
                        RSE_MDRI = c(0.05, 0.1), 
                        FRR = c(0.01, 0.02), 
                        RSE_FRR = c(0.20, 0.15), 
                        BigT = 730.5)$Inc.Difference.Statistics$RSE_deltaI,
               0.4110394,
               tolerance = 1e-07)
  expect_equal(incpower(I1 = 0.05, 
                        I2 = 0.03, 
                        PrevH1 = 0.20, 
                        PrevH2 = 0.20,
                        n1 = 5000, 
                        n2 = 5000, 
                        alpha = 0.05, 
                        Power = "out", 
                        SS = NULL,
                        DE_H = c(1,1.1), 
                        DE_R = 1, 
                        BMest = "MDRI.FRR.indep", 
                        MDRI = c(200, 180),
                        RSE_MDRI = c(0.05, 0.1),
                        FRR = c(0.01, 0.02), 
                        RSE_FRR = c(0.20, 0.15), 
                        BigT = 730.5)$Inc.Difference.Statistics$RSE_deltaI.infSS,
               0.2196649,
               tolerance = 1e-07)
  expect_equal(incpower(I1 = 0.05, 
                        I2 = 0.03, 
                        PrevH1 = 0.20, 
                        PrevH2 = 0.20,
                        alpha = 0.05, 
                        Power = 0.8, 
                        SS = "out",
                        DE_H = c(1,1.1), 
                        DE_R = 1, 
                        BMest = "MDRI.FRR.indep", 
                        MDRI = c(200, 180),
                        RSE_MDRI = c(0.05, 0.1), 
                        FRR = c(0.01, 0.02), 
                        RSE_FRR = c(0.20, 0.15),  
                        BigT = 730.5)$Minimum.Common.SS,
               7625)
  expect_equal(incpower(I1 = 0.05,
                        I2 = 0.03,
                        PrevH1 = 0.20,
                        PrevH2 = 0.20,
                        n1 = "out",
                        n2 = 5000,
                        SS = "out",
                        alpha = 0.05,
                        Power = 0.8,
                        DE_H = c(1.2, 1.3),
                        DE_R = 1,
                        BMest = "same.test",
                        MDRI = 200,
                        RSE_MDRI = 0.05,
                        FRR = 0.01,
                        RSE_FRR = 0.20,
                        BigT = 730.5)$Minimum.SS,
               4027)
  expect_equal(incpower(I1 = 0.05,
                        I2 = 0.03,
                        PrevH1 = 0.20,
                        PrevH2 = 0.20,
                        n1 = 5000,
                        n2 = "out",
                        SS = "out",
                        alpha = 0.05,
                        Power = 0.8,
                        DE_H = c(1.2, 1.3),
                        DE_R = 1,
                        BMest = "same.test",
                        MDRI = 200,
                        RSE_MDRI = 0.05,
                        FRR = 0.01,
                        RSE_FRR = 0.20,
                        BigT = 730.5)$Minimum.SS,
               3608)
  expect_equal(incpower(I1 = 0.05,
                        I2 = 0.03,
                        PrevH1 = 0.20,
                        PrevH2 = 0.20,
                        n1 = "out",
                        n2 = 5000,
                        SS = "out",
                        alpha = 0.05,
                        Power = 0.8,
                        DE_H = c(1.2, 1.3),
                        DE_R = 1,
                        BMest = "FRR.indep",
                        MDRI = 200,
                        RSE_MDRI = 0.05,
                        FRR = c(0.01, 0.02),
                        RSE_FRR = c(0.20, 0.15),
                        BigT = 730.5)$Minimum.SS,
               4615)
  expect_equal(incpower(I1 = 0.05,
                        I2 = 0.03,
                        PrevH1 = 0.20,
                        PrevH2 = 0.20,
                        n1 = 5000,
                        n2 = "out",
                        SS = "out",
                        alpha = 0.05,
                        Power = 0.8,
                        DE_H = c(1.2, 1.3),
                        DE_R = 1,
                        BMest = "FRR.indep",
                        MDRI = 200,
                        RSE_MDRI = 0.05,
                        FRR = c(0.01, 0.02),
                        RSE_FRR = c(0.20, 0.15),
                        BigT = 730.5)$Minimum.SS,
               4488)
  expect_equal(incpower(I1 = 0.05,
                        I2 = 0.03,
                        PrevH1 = 0.20,
                        PrevH2 = 0.20,
                        n1 = "out",
                        n2 = 5000,
                        SS = "out",
                        alpha = 0.05,
                        Power = 0.8,
                        DE_H = c(1.2, 1.3),
                        DE_R = 1,
                        BMest = "MDRI.FRR.indep",
                        MDRI = c(200, 180),
                        RSE_MDRI = c(0.05, 0.1),
                        FRR = c(0.01, 0.02),
                        RSE_FRR = c(0.20, 0.15), 
                        BigT = 730.5)$Minimum.SS,
               14470)
  expect_equal(incpower(I1 = 0.05,
                        I2 = 0.03,
                        PrevH1 = 0.20,
                        PrevH2 = 0.20,
                        n1 = 5000,
                        n2 = "out",
                        SS = "out",
                        alpha = 0.05,
                        Power = 0.8,
                        DE_H = c(1.2, 1.3),
                        DE_R = 1,
                        BMest = "MDRI.FRR.indep",
                        MDRI = c(200, 180),
                        RSE_MDRI = c(0.05, 0.1),
                        FRR = c(0.01, 0.02),
                        RSE_FRR = c(0.20, 0.15),
                        BigT = 730.5)$Minimum.SS,
               22579)
})

